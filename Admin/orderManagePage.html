<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AdminPage</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"
    ></script>
    <script src="./orderManage.js"></script>
    <script src="./ProductManage.js"></script>

    <link rel="stylesheet" href="/Admin/manage.css" />
  </head>
  <body>
    <!-- aside -->

    <aside class="aside-managepage">
      <div onclick="HomePage()" class="logo-set-small">
        <img
          id="icon-logo"
          style="width: 30px; height: 30px"
          src="/imgs/TnG Logo - 50x50.png"
          alt=""
        />
        <h5>HANDMADE TnG</h5>
      </div>
      <hr width="80%" size="1px" align="center" color="black" />

      <div id="group-aside-tag">
        <div class="aside-tag aside-choosed-tag">
          <i class="fa-solid fa-file-invoice-dollar"></i>
          <span style="padding-left: 10px">ĐƠN HÀNG</span>
        </div>
        <div class="aside-tag aside-unchoose-tag" onclick="productManagePage()">
          <i class="fa-solid fa-candy-cane"></i>
          <span style="padding-left: 10px">SẢN PHẨM</span>
        </div>
        <div class="aside-tag aside-unchoose-tag" onclick="userManagePage()">
          <i class="fa-solid fa-user-group"></i>
          <span style="padding-left: 10px">NGƯỜI DÙNG</span>
        </div>
      </div>
      <hr width="80%" size="1px" align="center" color="black" />

      <div class="aside-tag aside-unchoose-tag" onclick="adminManagePage()">
        <i class="fa-regular fa-address-card"></i>
        <span style="padding-left: 10px">QUẢN TRỊ VIÊN</span>
      </div>

      <hr width="80%" size="1px" align="center" color="black" />

      <h6 id="RoleMSG"></h6>
    </aside>

    <main class="main-managepage">
      <!-- nav bar -->
      <ul class="nav">
        <li class="nav-item">
          <button
            type="button"
            class="btn btn-Dark"
            data-bs-toggle="modal"
            data-bs-target="#showRevenue"
            onclick="handleRevenue()"
          >
            Doanh thu hôm này là <span id="revenueToday"></span>
          </button>
        </li>

        <nav class="set-header">
          <li class="nav-item">
            <nav class="navbar">
              <form class="form-inline">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon1"
                      >Tìm kiếm</span
                    >
                  </div>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Email khách hàng"
                    aria-label="Username"
                    aria-describedby="basic-addon1"
                    id="searchbox"
                    oninput="handleSearch()"
                  />
                </div>
              </form>
            </nav>
          </li>
          <li class="nav-item">
            <button onclick="handleLogout()" class="btn btn-secondary" href="#">
              Đăng xuất
            </button>
          </li>
        </nav>
      </ul>

      <!-- card -->
      <nav class="card card-admin">
        <table cellpadding="10" width="100%">
          <thead>
            <tr>
              <th>ID</th>
              <th>Email</th>
              <th>Số tiền</th>
              <th>Ngày</th>
              <th>Tình trạng đơn hàng</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </nav>

      <!-- Button trigger modal -->
      <!-- Modal add product  -->
      <div
        class="modal fade"
        id="showRevenue"
        data-bs-backdrop="static"
        data-bs-keyboard="false"
        tabindex="-1"
        aria-labelledby="staticBackdropLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="staticBackdropLabel">
                Doanh thu
              </h1>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div id="form2">
                <h6>Doanh thu hôm nay: <span id="revenueToday2"></span></h6>
                <h6>Doanh thu hôm qua: <span id="revenueYesterday"></span></h6>
                <hr />
                <h6>Doanh thu 7 ngày trước: <span id="revenue7Day"></span></h6>
                <h6>
                  Doanh thu 30 ngày trước: <span id="revenue30Day"></span>
                </h6>
                <hr />
                <h6>Doanh thu năm này: <span id="revenueThisYear"></span></h6>
                <h6>Doanh thu năm trước: <span id="revenueLastYear"></span></h6>
                <hr />
                <h6>Tổng doanh thu: <span id="revenueAlltime"></span></h6>
                <hr />
                <h6>
                  <span
                    ><input
                      onchange="handleRevenue2()"
                      id="revenueFrom"
                      type="date"
                  /></span>
                  <span></span
                  ><input
                    onchange="handleRevenue2()"
                    id="revenueTo"
                    type="date"
                  />
                </h6>
                <h6>Doanh thu trong khoảng thời gian trên:</h6>
                <h6 id="revenueTotal"></h6>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Đóng
              </button>
              <button
                style="margin-left: 10px"
                type="button"
                class="btn btn-danger"
                data-bs-dismiss="modal"
                onclick="handleAdd()"
              >
                Thêm sản phẩm
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Edit  -->
      <div
        class="modal fade"
        id="staticBackdrop"
        data-bs-backdrop="static"
        data-bs-keyboard="false"
        tabindex="-1"
        aria-labelledby="staticBackdropLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="staticBackdropLabel">
                Thông tin đơn hàng
              </h1>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div id="form">
                <p>ID đơn hàng: <span id="id-order"></span></p>
                <p>Thời gian đặt hàng: <span id="date-order"></span></p>
                <p>Email: <span id="email-order"></span></p>
                <hr />
                <h6>Thông tin giao hàng:</h6>
                <p>Điện thoại: <span id="phone-order"></span></p>
                <p>Địa chỉ: <span id="add-order"></span></p>
                <p>Lưu ý: <span id="note-order"></span></p>
                <hr />
                <h6>
                  Sản phẩm đặt hàng:
                  <!-- <span id="carts-order-list"></span> -->
                </h6>
                <table>
                  <tfoot id="carts-order"></tfoot>
                </table>
                <hr />
                <h6>Tổng số tiền: <span id="total-order"></span></h6>
                <hr />
                <p>Trạng thái đơn hàng: <span id="status-order"></span></p>
                <label for="">Cập nhật trạng thái:</label>
                <br />
                <select type="text" id="status-order-update">
                  <option></option>
                  <option>Từ chối đơn hàng</option>
                  <option>Đơn hàng đang được xử lý</option>
                  <option>Đơn hàng đang được giao tới địa chỉ nhận hàng</option>
                  <option>Đơn Hàng đã được giao</option>
                  <option>Đơn Hàng bị từ chối và chuyển hoàn</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Đóng
              </button>
              <button
                style="margin-left: 10px"
                type="button"
                class="btn btn-danger"
                data-bs-dismiss="modal"
                onclick="handleUpdate()"
              >
                Cập nhật trạng thái đơn hàng
              </button>
            </div>
          </div>
        </div>
      </div>

      <br />
    </main>
  </body>
  <script>
    const adminLogined = JSON.parse(localStorage.getItem("adminLogin"));
    if (adminLogined.Role == "ABC") {
      RoleMSG.innerHTML =
        "Xin chào, bạn có quyền quản trị cao nhất! Gồm quản lý đơn hàng, sản phẩm, tài khoản người mua hàng và quyền của các quản trị viên!";
    } else if (adminLogined.Role == "A") {
      RoleMSG.innerHTML = "Xin chào, bạn có quyền quản lý đơn hàng!";
    } else if (adminLogined.Role == "AB") {
      RoleMSG.innerHTML =
        "Xin chào, bạn có quyền quản lý đơn hàng và sản phẩm!";
    } else if (adminLogined.Role == "C") {
      RoleMSG.innerHTML =
        "Xin chào, bạn có quyền quản lý đơn hàng và người mua hàng!";
    }

    function handleLogout() {
      localStorage.removeItem("adminLogin");
      window.location = "LoginAdmin.html";
    }

    function orderManagePage() {
      window.location = "orderManagePage.html";
    }

    function productManagePage() {
      if (adminLogined.Role === "ABC" || adminLogined.Role === "AB") {
        window.location = "productManagePage.html";
      } else {
        let RoleMSG = document.querySelector("#RoleMSG");
        RoleMSG.innerHTML = "Bạn không có quyền truy cập quản lý sản phẩm!";
      }
    }

    function userManagePage() {
      if (adminLogined.Role === "ABC" || adminLogined.Role === "AC") {
        window.location = "userManagePage.html";
      } else {
        let RoleMSG = document.querySelector("#RoleMSG");
        RoleMSG.innerHTML = "Bạn không có quyền truy cập quản lý người dùng!";
      }
    }

    function adminManagePage() {
      if (adminLogined.Role === "ABC") {
        window.location = "AdminManagePage.html";
      } else {
        let RoleMSG = document.querySelector("#RoleMSG");
        RoleMSG.innerHTML =
          "Bạn không có quyền truy cập quản lý quản trị viên!";
      }
    }
    const orders = JSON.parse(localStorage.getItem("orders"));
    // Render output
    renderOrders(orders);

    // ------------------------------------
    // Render order

    function renderOrders(data) {
      let tbodyElement = document.querySelector("tbody");
      let contentTbody = "";
      data.forEach((order, index) => {
        // <td>${index + 1}</td> (backup để dùng nếu cần, thêm vào trước dòng           <td>${admin.email}</td> )
        let status = "";
        if (order.status == "0") {
          status = "Từ chối đơn hàng";
        } else if (order.status == "1") {
          status = "Đơn hàng đang được xử lý";
        } else if (order.status == "2") {
          status = "Đơn hàng đang được giao tới địa chỉ nhận hàng";
        } else if (order.status == "3") {
          status = "Đơn hàng đã được giao";
        } else if (order.status == "0.1") {
          status = "Giao hàng thất bại và chuyển hoàn";
        }

        let priceS = addS(order.totalPrice);
        // let name = product.name.slice(0, 20) + "...";

        contentTbody += `
            <tr>
              <td>${order.id}</td>
              <td>${order.email}</td>
              <td>${priceS}<span>đ</span></td>
              <td>${order.date}</td>
              <td>${status}</td>
              <td><button type="button" class="btn btn-secondary" style="margin-right: 10px" data-bs-toggle="modal" data-bs-target="#staticBackdrop" onclick="handleUpdateorder('${order.id}')">Thông tin</button></td>
            </tr>
            `;
      });
      tbodyElement.innerHTML = contentTbody;
    }

    // function search
    function handleSearch() {
      const inputvalue = document.querySelector("#searchbox").value;
      // console.log(inputvalue);
      let orders = JSON.parse(localStorage.getItem("orders"));
      let ordersSearch = [];

      orders.forEach((order) => {
        if (order.email.toUpperCase().includes(inputvalue.toUpperCase())) {
          console.log(order);
          ordersSearch.push(order);
        }
      });
      // console.log(ordersSearch)

      renderOrders(ordersSearch);
    }
    function handleRevenue2() {
      let revenueFromValue = new Date(
        document.querySelector("#revenueFrom").value
      );
      let revenueToValue = new Date(document.querySelector("#revenueTo").value);
      let revenueTotalValue = document.querySelector("#revenueTotal");
      var today = new Date();

      let revenueFrom = Days(revenueFromValue, today);
      let revenueTo = Days(revenueToValue, today);
      let revenueTotal = 0;

      if (!(Days(revenueFromValue, revenueToValue) >= 0)) {
        let revenueMsg = "Vui lòng nhập 2 mốc thời gian khác nhau";
        revenueTotalValue.innerHTML = revenueMsg;
        return;
      }
      let orders = JSON.parse(localStorage.getItem("orders"));
      if (
        Days2(revenueFromValue, today) < -1 ||
        Days2(revenueToValue, today) < -1
      ) {
        let revenueMsg = "Không thể chọn một mốc thời gian trong tương lai";
        revenueTotalValue.innerHTML = revenueMsg;
        return;
      }

      let From = 0;
      orders.forEach((order, index) => {
        var time = Days(order.date, today);
        if (time <= revenueFrom) {
          From += order.totalPrice;
        }
      });
      let To = 0;
      orders.forEach((order, index) => {
        var time = Days(order.date, today);
        if (time <= revenueTo) {
          To += order.totalPrice;
        }
      });

      revenueTotal = From - To;
      if (revenueTotal < 0) {
        revenueTotal = revenueTotal * -1;
      }
      revenueTotalValue.innerHTML = addS(revenueTotal) + "đ";
    }

    handleRevenue();
    function handleRevenue() {
      let revenueTodayValue = document.querySelector("#revenueToday");
      let revenueTodayValue2 = document.querySelector("#revenueToday2");

      let revenueYesterdayValue = document.querySelector("#revenueYesterday");
      let revenue7DayValue = document.querySelector("#revenue7Day");
      let revenue30DayValue = document.querySelector("#revenue30Day");
      let revenueThisYearValue = document.querySelector("#revenueThisYear");
      let revenueLastYearValue = document.querySelector("#revenueLastYear");
      let revenueAlltimeValue = document.querySelector("#revenueAlltime");

      let orders = JSON.parse(localStorage.getItem("orders"));
      var today = new Date();
      let revenueToday = 0;
      let revenueYesterday = 0;
      let revenue7Day = 0;
      let revenue30Day = 0;
      let revenueThisYear = 0;
      let revenueLastYear = 0;
      let revenueAlltime = 0;
      let revenueTotal = 0;

      orders.forEach((order, index) => {
        // var date = new Date(order.date);
        var time = Days(order.date, today);
        if (time <= 1) {
          revenueToday += order.totalPrice;
        }
      });

      orders.forEach((order, index) => {
        // var date = new Date(order.date);
        var time = Days(order.date, today);
        if (time <= 2 && time > 1) {
          revenueYesterday += order.totalPrice;
        }
      });

      orders.forEach((order, index) => {
        // var date = new Date(order.date);
        var time = Days(order.date, today);
        if (time <= 7) {
          revenue7Day += order.totalPrice;
        }
      });

      orders.forEach((order, index) => {
        // var date = new Date(order.date);
        var time = Days(order.date, today);
        if (time <= 30) {
          revenue30Day += order.totalPrice;
        }
      });

      orders.forEach((order, index) => {
        var date = new Date(order.date);

        if (date.getYear() == today.getYear()) {
          revenueThisYear += order.totalPrice;
        }
      });

      orders.forEach((order, index) => {
        var date = new Date(order.date);

        if (date.getYear() == today.getYear() - 1) {
          revenueLastYear += order.totalPrice;
          // console.log(order);
        }
      });

      orders.forEach((order, index) => {
        revenueAlltime += order.totalPrice;
      });

      revenueTodayValue.innerHTML = addS(revenueToday) + "đ";
      revenueTodayValue2.innerHTML = addS(revenueToday) + "đ";

      revenueYesterdayValue.innerHTML = addS(revenueYesterday) + "đ";
      revenue7DayValue.innerHTML = addS(revenue7Day) + "đ";
      revenue30DayValue.innerHTML = addS(revenue30Day) + "đ";
      revenueThisYearValue.innerHTML = addS(revenueThisYear) + "đ";
      revenueLastYearValue.innerHTML = addS(revenueLastYear) + "đ";
      revenueAlltimeValue.innerHTML = addS(revenueAlltime) + "đ";
    }

    function Days(startDay, endDay) {
      let daystart = new Date(startDay);
      let dayend = new Date(endDay);
      let day = (dayend.getTime() - daystart.getTime()) / 86400000;
      if (day < 0) {
        day = day * -1;
      }
      return day;
    }

    function Days2(startDay, endDay) {
      let daystart = new Date(startDay);
      let dayend = new Date(endDay);
      let day = (dayend.getTime() - daystart.getTime()) / 86400000;
      return day;
    }
    // Render modal
    function renderModal(order) {
      let idOrderElement = document.querySelector("#id-order");
      let dateOrderElement = document.querySelector("#date-order");
      let emailOrderElement = document.querySelector("#email-order");
      let phoneOrderElement = document.querySelector("#phone-order");
      let addOrderElement = document.querySelector("#add-order");
      let noteOrderElement = document.querySelector("#note-order");
      let cartsOrderElement = document.querySelector("tfoot");
      let totalOrderElement = document.querySelector("#total-order");
      let statusOrderElement = document.querySelector("#status-order");
      let cartsOrderlistElement = document.querySelector("#carts-order-list");

      let products = JSON.parse(localStorage.getItem("products"));
      let contentTfoot = "";
      // let sum = 0;
      order.carts.forEach((product) => {
        let priceS = addS(product.price);

        contentTfoot += `
            <tr>
              <td>${product.id}</td>
              <td><img src=${product.img[0]}  onmouseover='handleScreenIMG(this, "${product.img[1]}")' onmouseout='handleScreenIMG2(this, "${product.img[0]}")' alt="hello" class="img-icon" /></td>
              <td>${product.name}</td>
              <td>(${product.quantity})x</td>

              <td>${priceS}<span>đ</span></td>

            </tr>
            `;
      });

      let status = "";

      if (order.status == "0") {
        status = "Từ chối đơn hàng";
      } else if (order.status == "1") {
        status = "Đơn hàng đang được xử lý";
      } else if (order.status == "2") {
        status = "Đơn hàng đang được giao tới địa chỉ nhận hàng";
      } else if (order.status == "3") {
        status = "Đơn hàng đã được giao";
      } else if (order.status == "0.1") {
        status = "Giao hàng thất bại và chuyển hoàn";
      }

      idOrderElement.innerHTML = order?.id;
      dateOrderElement.innerHTML = order?.date;
      emailOrderElement.innerHTML = order?.email;
      phoneOrderElement.innerHTML = order?.phone;
      addOrderElement.innerHTML = order?.add;
      noteOrderElement.innerHTML = order?.note;
      cartsOrderElement.innerHTML = contentTfoot;
      // totalOrderElement.innerHTML = sum;

      totalOrderElement.innerHTML = order?.totalPrice;
      statusOrderElement.innerHTML = status;
      cartsOrderlistElement.innerHTML = order?.carts;
    }
    function handleScreenIMG(element, imgScreen) {
      element.src = imgScreen;
    }
    function handleScreenIMG2(element, imgScreen) {
      element.src = imgScreen;
    }

    function handleUpdateorder(orderUpdateID) {
      const orders = JSON.parse(localStorage.getItem("orders"));
      // const product = products.find((item) => item.id == id)
      // forEach tim product

      let orderUpdate;
      orders.forEach((item) => {
        if (item.id == orderUpdateID) {
          orderUpdate = item;
        }
      });

      // render vào modal
      renderModal(orderUpdate);
    }
    // Xử lý Update
    function handleUpdate() {
      let idOrderValue = document.querySelector("#id-order").innerHTML;
      let statusOrderValue = document.querySelector(
        "#status-order-update"
      ).value;

      // let carts = cartsOrderValue.split(",");
      let newstatus;
      if (statusOrderValue == "Từ chối đơn hàng") {
        newstatus = 0;
      } else if (statusOrderValue == "Đơn hàng đang được xử lý") {
        newstatus = 1;
      } else if (
        statusOrderValue == "Đơn hàng đang được giao tới địa chỉ nhận hàng"
      ) {
        newstatus = 2;
      } else if (statusOrderValue == "Đơn hàng đã được giao") {
        newstatus = 3;
      } else if (statusOrderValue == "Giao hàng thất bại và chuyển hoàn") {
        newstatus = 0.1;
      }

      // Lấy dữ liệu từ local về
      let orders = JSON.parse(localStorage.getItem("orders"));
      //
      let OrderClone;
      orders.forEach((order) => {
        if (order.id == idOrderValue) {
          OrderClone = Object.assign({}, order);
        }
      });
      if (newstatus == 0 || newstatus == 0.1) {
        OrderClone["totalPrice"] = 0;
      }
      OrderClone["status"] = newstatus;
      console.log(OrderClone);

      orders.forEach((order, i) => {
        if (order.id == idOrderValue) {
          orders.splice(i, 1, OrderClone);
        }
      });
      renderOrders(orders);
      localStorage.setItem("orders", JSON.stringify(orders));
    }

    // function xử lý số: thêm dấu [space]
    function addS(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // function xử lý số: bỏ dấu [space]
    function removeS(x) {
      let y = x.toString().replace(".", "");
      let z = y.toString().replace(".", "");
      return z.toString().replace(".", "");
    }
    function HomePage() {
      window.location = "../index.html";
    }
  </script>
</html>
