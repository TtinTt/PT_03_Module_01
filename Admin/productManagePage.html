<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AdminPage</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"
    ></script>
    <script src="./ProductManage.js"></script>

    <link rel="stylesheet" href="/Admin/manage.css" />
  </head>
  <body>
    <!-- aside -->

    <aside class="aside-managepage">
      <div onclick="HomePage()" class="logo-set-small">
        <img
          id="icon-logo"
          style="width: 30px; height: 30px"
          src="/imgs/TnG Logo - 50x50.png"
          alt=""
        />
        <h5>HANDMADE TnG</h5>
      </div>
      <hr width="80%" size="1px" align="center" color="black" />

      <div id="group-aside-tag">
        <div class="aside-tag aside-unchoose-tag" onclick="orderManagePage()">
          <i class="fa-solid fa-file-invoice-dollar"></i>
          <span style="padding-left: 10px">ĐƠN HÀNG</span>
        </div>
        <div class="aside-tag aside-choosed-tag">
          <i class="fa-solid fa-candy-cane"></i>
          <span style="padding-left: 10px">SẢN PHẨM</span>
        </div>
        <div class="aside-tag aside-unchoose-tag" onclick="userManagePage()">
          <i class="fa-solid fa-user-group"></i>
          <span style="padding-left: 10px">NGƯỜI DÙNG</span>
        </div>
      </div>
      <hr width="80%" size="1px" align="center" color="black" />

      <div class="aside-tag aside-unchoose-tag" onclick="adminManagePage()">
        <i class="fa-regular fa-address-card"></i>
        <span style="padding-left: 10px">QUẢN TRỊ VIÊN</span>
      </div>

      <hr width="80%" size="1px" align="center" color="black" />

      <h6 id="RoleMSG"></h6>
    </aside>

    <!-- main -->
    <main class="main-managepage">
      <!-- nav bar -->
      <ul class="nav">
        <li class="nav-item">
          <button
            type="button"
            class="btn btn-Dark"
            data-bs-toggle="modal"
            data-bs-target="#addproductmoda"
          >
            Thêm sản phẩm mới
          </button>
        </li>
        <nav class="set-header">
          <li class="nav-item">
            <nav class="navbar">
              <form class="form-inline">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon1"
                      >Tìm kiếm</span
                    >
                  </div>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Tên sản phẩm"
                    aria-label="Username"
                    aria-describedby="basic-addon1"
                    id="searchbox"
                    oninput="handleSearch()"
                  />
                </div>
              </form>
            </nav>
          </li>
          <li class="nav-item">
            <button onclick="handleLogout()" class="btn btn-secondary" href="#">
              Đăng xuất
            </button>
          </li>
        </nav>
      </ul>

      <!-- card -->
      <nav class="card card-admin">
        <table cellpadding="10" width="100%">
          <thead>
            <tr>
              <th>ID</th>
              <th>Ảnh</th>
              <th>Sản Phẩm</th>
              <th>Tag</th>
              <th>Giá</th>
              <th>Mô tả</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </nav>

      <!-- card -->

      <br />

      <p></p>
    </main>

    <!-- Modal Edit  -->
    <div
      class="modal fade"
      id="staticBackdrop"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Chỉnh sửa sản phẩm
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="form">
              <label for="id-product">ID</label>
              <input type="text" id="id-product" disabled />
              <br />
              <label for="name-product">Tên sản phẩm</label>
              <input type="text" id="name-product" />
              <br />
              <label for="img-product"
                >Url ảnh mô tả (các liên kết ngăn cách nhau bằng dấu
                phẩy)</label
              >
              <br />
              <textarea
                type="text"
                id="img-product"
                name=""
                cols="57"
                rows="10"
              ></textarea>
              <!-- <input type="text" id="img-product" /> -->
              <br />
              <label for="tag-product">Tag</label>
              <input type="text" id="tag-product" />
              <br />
              <label for="price-product">Giá</label>
              <input type="text" id="price-product" />
              <br />
              <label for="description-product">Mô tả</label>
              <input type="text" id="description-product" />
              <br />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              style="margin-left: 10px"
              type="button"
              class="btn btn-danger"
              data-bs-dismiss="modal"
              onclick="handleUpdate()"
            >
              Chỉnh sửa
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal add product  -->
    <div
      class="modal fade"
      id="addproductmoda"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Thêm sản phẩm
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="form">
              <label for="id-product-new">ID</label>
              <input type="text" id="id-product-new" disabled />
              <br />
              <label for="name-product-new">Tên sản phẩm</label>
              <input type="text" id="name-product-new" />
              <br />
              <label for="img-product-new"
                >Url ảnh mô tả (các liên kết ngăn cách nhau bằng dấu
                phẩy)</label
              >
              <br />
              <textarea
                type="text"
                id="img-product-new"
                name=""
                cols="57"
                rows="10"
              ></textarea>
              <!-- <input type="text" id="img-product" /> -->
              <br />
              <label for="tag-product-new">Tag</label>
              <input type="text" id="tag-product-new" />
              <br />
              <label for="price-product-new">Giá</label>
              <input type="text" id="price-product-new" />
              <br />
              <label for="description-product-new">Mô tả</label>
              <input type="text" id="description-product-new" />
              <br />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              style="margin-left: 10px"
              type="button"
              class="btn btn-danger"
              data-bs-dismiss="modal"
              onclick="handleAdd()"
            >
              Thêm sản phẩm
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Duplicator  -->
    <div
      class="modal fade"
      id="duplicatorModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Sao chép sản phẩm thành sản phẩm mới
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="form">
              <label for="id-product-dup">ID</label>
              <input type="text" id="id-product-dup" disabled />
              <br />
              <label for="name-product-dup">Tên sản phẩm</label>
              <input type="text" id="name-product-dup" />
              <br />
              <label for="img-product-dup"
                >Url ảnh mô tả (các liên kết ngăn cách nhau bằng dấu
                phẩy)</label
              >
              <br />
              <textarea
                type="text"
                id="img-product-dup"
                name=""
                cols="57"
                rows="10"
              ></textarea>
              <!-- <input type="text" id="img-product" /> -->
              <br />
              <label for="tag-product-dup">Tag</label>
              <input type="text" id="tag-product-dup" />
              <br />
              <label for="price-product-dup">Giá</label>
              <input type="text" id="price-product-dup" />
              <br />
              <label for="description-product-dup">Mô tả</label>
              <input type="text" id="description-product-dup" />
              <br />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              style="margin-left: 10px"
              type="button"
              class="btn btn-danger"
              data-bs-dismiss="modal"
              onclick="handleAddDup()"
            >
              Lưu thành sản phẩm mới
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- modal delete -->
    <div
      class="modal fade"
      id="deleteModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Xác nhận xóa sản phẩm <span id="delete-id-admin-msg"></span>:
              <span id="delete-admin-msg"></span>
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Hủy
            </button>
            <button
              style="margin-left: 10px"
              type="button"
              class="btn btn-danger"
              data-bs-dismiss="modal"
              onclick="handleDelete()"
            >
              Xác nhận xóa
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    const adminLogined = JSON.parse(localStorage.getItem("adminLogin"));
    if (adminLogined.Role == "ABC") {
      RoleMSG.innerHTML =
        "Xin chào, bạn có quyền quản trị cao nhất! Gồm quản lý đơn hàng, sản phẩm, tài khoản người mua hàng và quyền của các quản trị viên!";
    } else if (adminLogined.Role == "A") {
      RoleMSG.innerHTML = "Xin chào, bạn có quyền quản lý đơn hàng!";
    } else if (adminLogined.Role == "AB") {
      RoleMSG.innerHTML =
        "Xin chào, bạn có quyền quản lý đơn hàng và sản phẩm!";
    } else if (adminLogined.Role == "C") {
      RoleMSG.innerHTML =
        "Xin chào, bạn có quyền quản lý đơn hàng và người mua hàng!";
    }

    function handleLogout() {
      localStorage.removeItem("adminLogin");
      window.location = "LoginAdmin.html";
    }

    function orderManagePage() {
      window.location = "orderManagePage.html";
    }

    function productManagePage() {
      if (adminLogined.Role === "ABC" || adminLogined.Role === "AB") {
        window.location = "productManagePage.html";
      } else {
        let RoleMSG = document.querySelector("#RoleMSG");
        RoleMSG.innerHTML = "Bạn không có quyền truy cập quản lý sản phẩm!";
      }
    }

    function userManagePage() {
      if (adminLogined.Role === "ABC" || adminLogined.Role === "AC") {
        window.location = "userManagePage.html";
      } else {
        let RoleMSG = document.querySelector("#RoleMSG");
        RoleMSG.innerHTML = "Bạn không có quyền truy cập quản lý người dùng!";
      }
    }

    function adminManagePage() {
      if (adminLogined.Role === "ABC") {
        window.location = "AdminManagePage.html";
      } else {
        let RoleMSG = document.querySelector("#RoleMSG");
        RoleMSG.innerHTML =
          "Bạn không có quyền truy cập quản lý quản trị viên!";
      }
    }

    const products = JSON.parse(localStorage.getItem("products"));
    // Render output
    renderProducts(products);

    // ------------------------------------
    // Render Product
    function renderProducts(data) {
      let tbodyElement = document.querySelector("tbody");
      let contentTbody = "";
      data.forEach((product, index) => {
        let priceS = addS(product.price);
        let name = product.name.slice(0, 20) + "...";

        contentTbody += `
        <tr>
          <td>${product.id}</td>
          <td><img src=${product.img[0]} onmouseover='handleScreenIMG(this, "${product.img[1]}")' onmouseout='handleScreenIMG2(this, "${product.img[0]}")' alt="hello" class="img-icon" />
        </td>
        <td>${product.name}</td>
        <td>${product.tag}</td>


        <td>${priceS}<span>đ</span></td>
        <td>${product.description}</td>

          <td><button type="button" class="btn btn-secondary" style="margin-right: 10px" data-bs-toggle="modal" data-bs-target="#staticBackdrop" onclick="handleEdit('${product.id}')">Sửa</button><button class="btn btn-danger" style="margin-right: 10px" data-bs-toggle="modal" data-bs-target="#deleteModal" onclick="renderDelete('${product.name}','${product.id}')">Xoá</button><button type="button" class="btn btn-secondary" style="margin-right: 10px" data-bs-toggle="modal" data-bs-target="#duplicatorModal" onclick="handleDuplicator('${product.id}')">Sao chép</button></td>

        </tr>
        `;
      });
      tbodyElement.innerHTML = contentTbody;
    }
    // function search
    function handleSearch() {
      const inputvalue = document.querySelector("#searchbox").value;
      // console.log(inputvalue);
      let products = JSON.parse(localStorage.getItem("products"));
      let productsSearch = [];

      products.forEach((product) => {
        if (
          removeAccents(product.name)
            .toUpperCase()
            .includes(removeAccents(inputvalue).toUpperCase())
        ) {
          console.log(product);
          productsSearch.push(product);
        }
      });
      // console.log(productsSearch)

      renderProducts(productsSearch);
    }

    function handleScreenIMG(element, imgScreen) {
      element.src = imgScreen;
    }
    function handleScreenIMG2(element, imgScreen) {
      element.src = imgScreen;
    }
    // Render modal
    function renderModal(product) {
      const idElement = document.querySelector("#id-product");
      const nameElement = document.querySelector("#name-product");
      const imgElement = document.querySelector("#img-product");
      const tagElement = document.querySelector("#tag-product");
      const priceElement = document.querySelector("#price-product");
      const descriptionElement = document.querySelector("#description-product");

      idElement.value = product?.id;
      nameElement.value = product?.name;
      imgElement.value = product?.img;
      tagElement.value = product?.tag;
      priceElement.value = product?.price;
      descriptionElement.value = product?.description;
    }
    function renderModal2(product) {
      // const idElement = document.querySelector("#id-product-dup");
      const nameElement = document.querySelector("#name-product-dup");
      const imgElement = document.querySelector("#img-product-dup");
      const tagElement = document.querySelector("#tag-product-dup");
      const priceElement = document.querySelector("#price-product-dup");
      const descriptionElement = document.querySelector(
        "#description-product-dup"
      );
      // idElement.value = product?.id;
      nameElement.value = product?.name;
      imgElement.value = product?.img;
      tagElement.value = product?.tag;
      priceElement.value = product?.price;
      descriptionElement.value = product?.description;
    }

    function handleEdit(editProduct) {
      const products = JSON.parse(localStorage.getItem("products"));
      // const product = products.find((item) => item.id == id)
      // forEach tim product

      let productEdit;
      products.forEach((product) => {
        if (product.id == editProduct) {
          productEdit = product;
        }
      });

      // render vào modal
      renderModal(productEdit);
    }

    function handleDuplicator(editProduct) {
      const products = JSON.parse(localStorage.getItem("products"));
      // const product = products.find((item) => item.id == id)
      // forEach tim product

      let productEdit;
      products.forEach((product) => {
        if (product.id == editProduct) {
          productEdit = product;
        }
      });

      // render vào modal
      renderModal2(productEdit);
    }
    // Xử lý Update
    function handleUpdate() {
      const idValue = document.querySelector("#id-product").value;
      const nameValue = document.querySelector("#name-product").value;
      const imgValue = document.querySelector("#img-product").value;
      const tagValue = document.querySelector("#tag-product").value;
      const priceValue = document.querySelector("#price-product").value;
      const descriptionValue = document.querySelector(
        "#description-product"
      ).value;
      let imglink = imgValue.split(",");
      //
      const newProduct = {
        id: Number(idValue),
        name: nameValue,
        img: imglink,
        tag: tagValue,
        price: priceValue,
        description: descriptionValue,
      };
      // console.log(newProduct);
      // Lấy dữ liệu từ local về
      let products = JSON.parse(localStorage.getItem("products"));
      products.forEach((product, i) => {
        if (product.id == idValue) {
          products.splice(i, 1, newProduct);
        }
      });
      renderProducts(products);
      localStorage.setItem("products", JSON.stringify(products));
    }
    function handleAdd() {
      const nameValue = document.querySelector("#name-product-new").value;
      const imgValue = document.querySelector("#img-product-new").value;
      const tagValue = document.querySelector("#tag-product-new").value;
      const priceValue = document.querySelector("#price-product-new").value;
      const descriptionValue = document.querySelector(
        "#description-product-new"
      ).value;
      let imglink = imgValue.split(",");
      // Lấy dữ liệu từ local về

      let products = JSON.parse(localStorage.getItem("products"));

      const newProduct = {
        id: Number(products[products.length - 1]?.id) + 1,
        name: nameValue,
        img: imglink,
        tag: tagValue,
        price: priceValue,
        description: descriptionValue,
      };

      products.push(newProduct);
      renderProducts(products);
      localStorage.setItem("products", JSON.stringify(products));
    }
    function handleAddDup() {
      const nameValue = document.querySelector("#name-product-dup").value;
      const imgValue = document.querySelector("#img-product-dup").value;
      const tagValue = document.querySelector("#tag-product-dup").value;
      const priceValue = document.querySelector("#price-product-dup").value;
      const descriptionValue = document.querySelector(
        "#description-product-dup"
      ).value;
      let imglink = imgValue.split(",");
      // Lấy dữ liệu từ local về

      let products = JSON.parse(localStorage.getItem("products"));

      const newProduct = {
        id: Number(products[products.length - 1]?.id) + 1,
        name: nameValue,
        img: imglink,
        tag: tagValue,
        price: priceValue,
        description: descriptionValue,
      };

      products.push(newProduct);
      renderProducts(products);
      localStorage.setItem("products", JSON.stringify(products));
    }
    // handle Delete
    function renderDelete(deleteProduct, deleteIDProduct) {
      const deleteIDMsg = document.querySelector("#delete-id-admin-msg");
      const deleteMsg = document.querySelector("#delete-admin-msg");
      deleteIDMsg.innerHTML = deleteIDProduct;
      deleteMsg.innerHTML = deleteProduct;
    }

    function handleDelete() {
      const idValue = document.querySelector("#delete-id-admin-msg").innerHTML;
      const products = JSON.parse(localStorage.getItem("products"));
      products.forEach((product, i) => {
        if (product.id == idValue) {
          products.splice(i, 1);
        }
      });
      localStorage.setItem("products", JSON.stringify(products));
      renderProducts(products);
    }

    // function xử lý số: thêm dấu [space]
    function addS(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // function xử lý số: bỏ dấu [space]
    function removeS(x) {
      let y = x.toString().replace(".", "");
      let z = y.toString().replace(".", "");
      return z.toString().replace(".", "");
    }
    function HomePage() {
      window.location = "../index.html";
    }

    function removeAccents(str) {
      return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/đ/g, "d")
        .replace(/Đ/g, "D");
    }
  </script>
</html>
