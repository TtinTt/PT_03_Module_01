<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AdminPage</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"
    ></script>
    <script src="./AdminManage.js"></script>

    <link rel="stylesheet" href="/Admin/manage.css" />
  </head>
  <body>
    <!-- aside -->

    <aside class="aside-managepage">
      <div onclick="HomePage()" class="logo-set-small">
        <img
          id="icon-logo"
          style="width: 30px; height: 30px"
          src="/imgs/TnG Logo - 50x50.png"
          alt=""
        />
        <h5>HANDMADE TnG</h5>
      </div>
      <hr width="80%" size="1px" align="center" color="black" />

      <div id="group-aside-tag">
        <div class="aside-tag aside-unchoose-tag" onclick="orderManagePage()">
          <i class="fa-solid fa-file-invoice-dollar"></i>
          <span style="padding-left: 10px">ĐƠN HÀNG</span>
        </div>
        <div class="aside-tag aside-unchoose-tag" onclick="productManagePage()">
          <i class="fa-solid fa-candy-cane"></i>
          <span style="padding-left: 10px">SẢN PHẨM</span>
        </div>
        <div class="aside-tag aside-unchoose-tag" onclick="userManagePage()">
          <i class="fa-solid fa-user-group"></i>
          <span style="padding-left: 10px">NGƯỜI DÙNG</span>
        </div>
      </div>
      <hr width="80%" size="1px" align="center" color="black" />

      <div class="aside-tag aside-choosed-tag">
        <i class="fa-regular fa-address-card"></i>
        <span style="padding-left: 10px">QUẢN TRỊ VIÊN</span>
      </div>

      <hr width="80%" size="1px" align="center" color="black" />

      <h6 id="RoleMSG"></h6>
    </aside>

    <!-- main -->
    <main class="main-managepage">
      <!-- nav bar -->
      <ul class="nav">
        <li class="nav-item">
          <button
            type="button"
            class="btn btn-Dark btn-action"
            data-bs-toggle="modal"
            data-bs-target="#addadmin"
          >
            Thêm quản trị viên
          </button>
        </li>
        <nav class="set-header">
          <li class="nav-item">
            <nav class="navbar">
              <form class="form-inline">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon1"
                      >Tìm kiếm</span
                    >
                  </div>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Email quản trị viên"
                    aria-label="Username"
                    aria-describedby="basic-addon1"
                    id="searchbox"
                    oninput="handleSearch()"
                  />
                </div>
              </form>
            </nav>
          </li>
          <li class="nav-item">
            <button onclick="handleLogout()" class="btn btn-secondary" href="#">
              Đăng xuất
            </button>
          </li>
        </nav>
      </ul>

      <!-- card -->
      <nav class="card card-admin">
        <table cellpadding="10" width="100%">
          <thead>
            <tr>
              <!-- <th>ID</th> -->
              <th>Email</th>
              <th>Phân quyền quản trị</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </nav>

      <!-- card -->
    </main>

    <!-- Button trigger modal -->

    <!-- Modal Edit  -->
    <div
      class="modal fade"
      id="staticBackdrop"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">Chỉnh sửa</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="form">
              <!-- <label for="id-admin">ID</label>
                  <input type="text" id="id-admin" disabled /> -->
              <br />
              <label for="email-admin">Email</label>
              <input type="text" id="email-admin" disabled />
              <br />
              <label for="role-admin">Phân quyền quản trị </label>
              <br />
              <select type="text" id="role-admin">
                <option selected="selected">Đơn hàng</option>
                <option>Đơn hàng và sản phẩm</option>
                <option>Đơn hàng và người dùng</option>
                <option>Đơn hàng, sản phẩm, người dùng và quản trị viên</option>
              </select>
              <br />
              <label for="password-admin">Password</label>
              <input type="password" id="password-admin" p />
              <br />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              style="margin-left: 10px"
              type="button"
              class="btn btn-danger"
              data-bs-dismiss="modal"
              onclick="handleUpdate()"
            >
              Chỉnh sửa
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Moda 2  add admin -->
    <div
      class="modal fade"
      id="addadmin"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Thêm quản trị viên
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="form">
              <!-- <label for="id-admin">ID</label>
                <input type="text" id="id-admin" disabled /> -->
              <br />
              <label for="email-admin-new">Email</label>
              <input type="text" id="email-admin-new" />
              <br />
              <label for="role-admin">Phân quyền quản trị </label>
              <br />
              <select type="text" id="role-admin-new">
                <option selected="selected">Đơn hàng</option>
                <option>Đơn hàng và sản phẩm</option>
                <option>Đơn hàng và người dùng</option>
                <option>Đơn hàng, sản phẩm, người dùng và quản trị viên</option>
              </select>
              <br />
              <label for="password-admin-new">Password</label>
              <input type="password" id="password-admin-new" p />
              <br />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              style="margin-left: 10px"
              type="button"
              class="btn btn-danger"
              data-bs-dismiss="modal"
              onclick="handleAdd()"
            >
              Thêm
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- modal 3 -->
    <div
      class="modal fade"
      id="deleteModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Xác nhận xóa quản trị viên <span id="delete-admin-msg"></span>
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Hủy
            </button>
            <button
              style="margin-left: 10px"
              type="button"
              class="btn btn-danger"
              data-bs-dismiss="modal"
              onclick="handleDelete()"
            >
              Xác nhận xóa
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    const adminLogined = JSON.parse(localStorage.getItem("adminLogin"));
    if (adminLogined.Role == "ABC") {
      RoleMSG.innerHTML =
        "Xin chào, bạn có quyền quản trị cao nhất! Gồm quản lý đơn hàng, sản phẩm, tài khoản người mua hàng và quyền của các quản trị viên!";
    } else if (adminLogined.Role == "A") {
      RoleMSG.innerHTML = "Xin chào, bạn có quyền quản lý đơn hàng!";
    } else if (adminLogined.Role == "AB") {
      RoleMSG.innerHTML =
        "Xin chào, bạn có quyền quản lý đơn hàng và sản phẩm!";
    } else if (adminLogined.Role == "C") {
      RoleMSG.innerHTML =
        "Xin chào, bạn có quyền quản lý đơn hàng và người mua hàng!";
    }

    function handleLogout() {
      localStorage.removeItem("adminLogin");
      window.location = "LoginAdmin.html";
    }

    function orderManagePage() {
      window.location = "orderManagePage.html";
    }

    function productManagePage() {
      if (adminLogined.Role === "ABC" || adminLogined.Role === "AB") {
        window.location = "productManagePage.html";
      } else {
        let RoleMSG = document.querySelector("#RoleMSG");
        RoleMSG.innerHTML = "Bạn không có quyền truy cập quản lý sản phẩm!";
      }
    }

    function userManagePage() {
      if (adminLogined.Role === "ABC" || adminLogined.Role === "AC") {
        window.location = "userManagePage.html";
      } else {
        let RoleMSG = document.querySelector("#RoleMSG");
        RoleMSG.innerHTML = "Bạn không có quyền truy cập quản lý người dùng!";
      }
    }

    function adminManagePage() {
      if (adminLogined.Role === "ABC") {
        window.location = "AdminManagePage.html";
      } else {
        let RoleMSG = document.querySelector("#RoleMSG");
        RoleMSG.innerHTML =
          "Bạn không có quyền truy cập quản lý quản trị viên!";
      }
    }

    const admins = JSON.parse(localStorage.getItem("admins"));
    // Render output
    renderAdmins(admins);

    // ------------------------------------
    // Render Product
    function renderAdmins(data) {
      let tbodyElement = document.querySelector("tbody");
      let contentTbody = "";
      data.forEach((admin, index) => {
        // <td>${index + 1}</td> (backup để dùng nếu cần, thêm vào trước dòng           <td>${admin.email}</td> )

        let role = "";
        if (admin.Role === "ABC") {
          role = "Đơn hàng, sản phẩm, người dùng và quản trị viên";
        } else if (admin.Role == "A") {
          role = "Đơn Hàng";
        } else if (admin.Role == "AB") {
          role = "Đơn Hàng và Sản Phẩm";
        } else if (admin.Role == "AC") {
          role = "Đơn Hàng và Người Dùng";
        }
        contentTbody += `
        <tr>

          <td>${admin.email}</td>
          <td>${role}</td>
          <td><button type="button" class="btn btn-secondary" style="margin-right: 10px" data-bs-toggle="modal" data-bs-target="#staticBackdrop" onclick="handleEdit('${admin.email}')">Sửa</button><button class="btn btn-danger" style="margin-right: 10px" data-bs-toggle="modal" data-bs-target="#deleteModal" onclick="renderDelete('${admin.email}')">Xoá</button></td>
        </tr>
        `;
      });
      tbodyElement.innerHTML = contentTbody;
    }
    // function search
    function handleSearch() {
      const inputvalue = document.querySelector("#searchbox").value;
      // console.log(inputvalue);
      let admins = JSON.parse(localStorage.getItem("admins"));
      let adminsSearch = [];

      admins.forEach((admin) => {
        if (admin.email.toUpperCase().includes(inputvalue.toUpperCase())) {
          console.log(admin);
          adminsSearch.push(admin);
        }
      });
      // console.log(ordersSearch)
      renderAdmins(adminsSearch);
    }

    // Render modal
    function renderModal(admin) {
      // const idElement = document.querySelector("#id-admin");
      const emailElement = document.querySelector("#email-admin");
      // const roleElement = document.querySelector("#role-admin");
      const passwordElement = document.querySelector("#password-admin");

      emailElement.value = admin.email;
      roleElement.value = admin?.Role;
      passwordElement.value = admin?.password;
    }

    function handleEdit(editEmail) {
      const admins = JSON.parse(localStorage.getItem("admins"));
      // const product = products.find((item) => item.id == id)
      // forEach tim product

      let adminEdit;
      admins.forEach((item) => {
        if (item.email == editEmail) {
          adminEdit = item;
        }
      });

      // render vào modal
      renderModal(adminEdit);
    }
    // Xử lý Update
    function handleUpdate() {
      // const idValue = document.querySelector("#id-product").value;
      const emailValue = document.querySelector("#email-admin").value;
      const roleValue = document.querySelector("#role-admin").value;
      const passwordValue = document.querySelector("#password-admin").value;

      //
      let role = "";
      if (roleValue === "Đơn hàng") {
        role = "A";
      } else if (roleValue === "Đơn hàng và sản phẩm") {
        role = "AB";
      } else if (roleValue === "Đơn hàng và người dùng") {
        role = "AC";
      } else if (
        roleValue === "Đơn hàng, sản phẩm, người dùng và quản trị viên"
      ) {
        role = "ABC";
      }

      //
      const newAdmin = {
        email: emailValue,
        password: passwordValue,
        Role: role,
      };

      // Lấy dữ liệu từ local về
      let admins = JSON.parse(localStorage.getItem("admins"));
      admins.forEach((admin, i) => {
        if (admin.email == emailValue) {
          admins.splice(i, 1, newAdmin);
        }
      });
      renderAdmins(admins);
      localStorage.setItem("admins", JSON.stringify(admins));
    }
    function handleAdd() {
      // const idValue = document.querySelector("#id-product").value;
      const emailValue = document.querySelector("#email-admin-new").value;
      const roleValue = document.querySelector("#role-admin-new").value;
      const passwordValue = document.querySelector("#password-admin-new").value;
      //
      let role = "";
      if (roleValue === "Đơn hàng") {
        role = "A";
      } else if (roleValue === "Đơn hàng và sản phẩm") {
        role = "AB";
      } else if (roleValue === "Đơn hàng và người dùng") {
        role = "AC";
      } else if (
        roleValue === "Đơn hàng, sản phẩm, người dùng và quản trị viên"
      ) {
        role = "ABC";
      }

      //
      const newAdmin = {
        email: emailValue,
        password: passwordValue,
        Role: role,
      };

      // Lấy dữ liệu từ local về
      let admins = JSON.parse(localStorage.getItem("admins"));
      admins.push(newAdmin);
      renderAdmins(admins);
      localStorage.setItem("admins", JSON.stringify(admins));
    }
    // handle Delete
    function renderDelete(deleteEmail) {
      const deleteMsg = document.querySelector("#delete-admin-msg");
      deleteMsg.innerHTML = deleteEmail;
    }

    function handleDelete() {
      const emailValue = document.querySelector("#delete-admin-msg").innerHTML;
      const admins = JSON.parse(localStorage.getItem("admins"));
      admins.forEach((admin, i) => {
        if (admin.email == emailValue) {
          admins.splice(i, 1);
        }
      });
      localStorage.setItem("admins", JSON.stringify(admins));
      renderAdmins(admins);
    }

    function HomePage() {
      window.location = "../index.html";
    }
  </script>
</html>
